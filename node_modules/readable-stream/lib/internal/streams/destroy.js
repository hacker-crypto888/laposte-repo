<<<<<<< HEAD
'use strict'; // undocumented cb() API, needed for core, not for public API

=======
'use strict';

/*<replacement>*/

var pna = require('process-nextick-args');
/*</replacement>*/

// undocumented cb() API, needed for core, not for public API
>>>>>>> d6c7f16eb2ad1b8e2cdf3a08b4433e01e5538c0a
function destroy(err, cb) {
  var _this = this;

  var readableDestroyed = this._readableState && this._readableState.destroyed;
  var writableDestroyed = this._writableState && this._writableState.destroyed;

  if (readableDestroyed || writableDestroyed) {
    if (cb) {
      cb(err);
    } else if (err && (!this._writableState || !this._writableState.errorEmitted)) {
<<<<<<< HEAD
      process.nextTick(emitErrorNT, this, err);
    }

    return this;
  } // we set destroyed to true before firing error callbacks in order
  // to make it re-entrance safe in case destroy() is called within callbacks


  if (this._readableState) {
    this._readableState.destroyed = true;
  } // if this is a duplex stream mark the writable part as destroyed as well


=======
      pna.nextTick(emitErrorNT, this, err);
    }
    return this;
  }

  // we set destroyed to true before firing error callbacks in order
  // to make it re-entrance safe in case destroy() is called within callbacks

  if (this._readableState) {
    this._readableState.destroyed = true;
  }

  // if this is a duplex stream mark the writable part as destroyed as well
>>>>>>> d6c7f16eb2ad1b8e2cdf3a08b4433e01e5538c0a
  if (this._writableState) {
    this._writableState.destroyed = true;
  }

  this._destroy(err || null, function (err) {
    if (!cb && err) {
<<<<<<< HEAD
      process.nextTick(emitErrorAndCloseNT, _this, err);

=======
      pna.nextTick(emitErrorNT, _this, err);
>>>>>>> d6c7f16eb2ad1b8e2cdf3a08b4433e01e5538c0a
      if (_this._writableState) {
        _this._writableState.errorEmitted = true;
      }
    } else if (cb) {
<<<<<<< HEAD
      process.nextTick(emitCloseNT, _this);
      cb(err);
    } else {
      process.nextTick(emitCloseNT, _this);
=======
      cb(err);
>>>>>>> d6c7f16eb2ad1b8e2cdf3a08b4433e01e5538c0a
    }
  });

  return this;
}

<<<<<<< HEAD
function emitErrorAndCloseNT(self, err) {
  emitErrorNT(self, err);
  emitCloseNT(self);
}

function emitCloseNT(self) {
  if (self._writableState && !self._writableState.emitClose) return;
  if (self._readableState && !self._readableState.emitClose) return;
  self.emit('close');
}

=======
>>>>>>> d6c7f16eb2ad1b8e2cdf3a08b4433e01e5538c0a
function undestroy() {
  if (this._readableState) {
    this._readableState.destroyed = false;
    this._readableState.reading = false;
    this._readableState.ended = false;
    this._readableState.endEmitted = false;
  }

  if (this._writableState) {
    this._writableState.destroyed = false;
    this._writableState.ended = false;
    this._writableState.ending = false;
<<<<<<< HEAD
    this._writableState.finalCalled = false;
    this._writableState.prefinished = false;
=======
>>>>>>> d6c7f16eb2ad1b8e2cdf3a08b4433e01e5538c0a
    this._writableState.finished = false;
    this._writableState.errorEmitted = false;
  }
}

function emitErrorNT(self, err) {
  self.emit('error', err);
}

module.exports = {
  destroy: destroy,
  undestroy: undestroy
};